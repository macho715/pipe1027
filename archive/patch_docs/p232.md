ì¢‹ì•„, ë„¤ ë³´ê³ ì„œ ê²°ë¡ ì€ í•µì‹¬ì„ ì œëŒ€ë¡œ ì°”ë €ë‹¤. **ë™ì¼ ì‹œì (ê°™ì€ ts)ì—ì„œ WHâ†’Site ì´ë™ì´ ë¹ ì§€ëŠ” ì¼€ì´ìŠ¤**ê°€ ì¬ê³ ë¥¼ ë¶€í’€ë ¸ê³ , ì›ì¸ì€ â€œë™ì¼ ì‹œì  ì •ë ¬ ìš°ì„ ìˆœìœ„(STAGE_PRIO)â€ì™€ â€œìµœì¢… ìƒíƒœ ì„ ë³„â€ì˜ ì¡°í•©ì´ì—ˆë‹¤. ì•„ë˜ì²˜ëŸ¼ **ë”± í•„ìš”í•œ ê³³ë§Œ** ë°”ê¾¸ë©´, ë™ì¼ ì‹œì ì—ë„ WHâ†’Site OUTì´ ì •í™•íˆ ì°í˜€ì„œ ì›”ë³„ ì…Â·ì¶œê³ Â·ëˆ„ì ì´ í”¼ë²—(ìµœì¢… ìœ„ì¹˜)ê³¼ ë§ëŠ”ë‹¤.

---

# Exec Summary (3ì¤„)

* ë°±ì—… ë¡œì§ì€ ë™ì¼ ì‹œì  ì²˜ë¦¬ ì‹œ **ì°½ê³ ë§Œ í•„í„°**í•´ Siteë¡œì˜ ë‹¹ì¼ ì¶œê³ ë¥¼ ëˆ„ë½.
* í˜„í–‰ ë¡œì§ì€ â€œê²½ë¡œ(path) ì „ì›(WH+Site)â€ì„ ì½ì§€ë§Œ, **ì •ë ¬ ìš°ì„ ìˆœìœ„(ì°½ê³ >ì‚¬ì´íŠ¸)** ë•Œë¬¸ì— ë™ì¼ ì‹œì ì´ **Siteâ†’WH(ì…ê³ )**ë¡œë§Œ ì¡íˆëŠ” êµ¬ê°„ì´ ë‚¨ìŒ.
* í•´ë²•: **STAGE_PRIOë¥¼ Site ìµœì¢… ìŠ¹ì**ë¡œ ë°”ê¾¸ì–´ ë™ì¼ ì‹œì ì´ **WHâ†’Site(ì¶œê³ )**ë¡œ í•´ì„ë˜ê²Œ í•˜ê³ , í˜„ ë¡œì§ì˜ path ì „ì´/ìµœì¢…ìƒíƒœ íƒ€ì„ë¼ì¸ì„ ê·¸ëŒ€ë¡œ í™œìš©.

---

# ë³€ê²½ ì§€ì‹œ (ì •í™•í•œ ìœ„ì¹˜/ì½”ë“œ ì¡°ê°)

## 1) `flow_ledger_v2.py` â€” STAGE_PRIO í•œ ì¤„ êµì²´

ë™ì¼ ì‹œì  ì •ë ¬ì—ì„œ â€œSiteê°€ ë’¤(ìµœì¢…)â€ë¡œ ì˜¤ë„ë¡ ë°”ê¾¼ë‹¤.

```python
# ê¸°ì¡´
STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "site": 2, "warehouse": 3}  # ì°½ê³  ìµœì¢…

# êµì²´(íŒ¨ì¹˜)
STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "warehouse": 2, "site": 3}  # ì‚¬ì´íŠ¸ ìµœì¢…
```

> ì´ë ‡ê²Œ ë°”ê¾¸ë©´ ë™ì¼ tsì— `[DSV Indoor(WH), DAS(Site)]` ìˆœì„œê°€ ë˜ì–´ **(WHâ†’Site)** ì „ì´ë¡œ OUTì´ ìƒì„±ëœë‹¤(í˜„í–‰ path í•´ì„ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©).
> ì°¸ê³ : ì›” ì§‘ê³„ëŠ” `pivot_table(..., aggfunc='sum', fill_value=0)`ë¡œ ê²°ì¸¡ì„ 0ìœ¼ë¡œ ì±„ìš°ê³ , ëˆ„ì ì€ `(ì…ê³ âˆ’ì¶œê³ ).cumsum()`ì´ ì •ì„ì´ë‹¤. ([pandas.pydata.org][1])

## 2) ê·¸ ì™¸ ë¡œì§ì€ ìœ ì§€

* **ë™ì¼ ì‹œì  ì²´ì¸ ì „ì´(path) ìƒì„±**: ì°½ê³ â†”ì°½ê³ , **ì°½ê³ â†’ì‚¬ì´íŠ¸(OUT)**, ì‚¬ì´íŠ¸â†’ì°½ê³ (IN) ëª¨ë‘ ì²˜ë¦¬(ì´ë¯¸ êµ¬í˜„ë¨).
* **ì—°ì† ì‹œì  ì „ì´**: ì‹œê°ë‹¹ **ìµœì¢… ìƒíƒœ 1ê°œ**ë§Œ ë¹„êµ(ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€).
* **íƒ€ì„ì¡´/ì›” ë²„í‚·**: tz-naiveâ†’`tz_localize('Asia/Dubai')`, tz-awareâ†’`tz_convert('Asia/Dubai')` í›„ ì›”(`%Y-%m`) ì‚°ì¶œ ê¶Œì¥. ([pandas.pydata.org][2])
* **ì‹œê°„ íŒŒì‹±**: `pd.to_datetime(..., errors='coerce')`ë¡œ ë¶ˆê°€ì¹˜ëŠ” NaT ì²˜ë¦¬. ([pandas.pydata.org][3])

---

# ì™œ ì´ê²Œ ë§ë‚˜ (ì§§ê²Œ)

* **ì •ë ¬ ìš°ì„ ìˆœìœ„ê°€ í•´ì„ì„ ê²°ì •**í•œë‹¤. ë™ì¼ tsì—ì„œ WHì™€ Siteê°€ í•¨ê»˜ ì°íˆë©´, ë’¤ì— ì˜¤ëŠ” ìª½ì´ â€œìµœì¢… ìƒíƒœâ€ê°€ ë˜ì–´ path ì¸ì ‘ìŒì´ **WHâ†’Site**(OUT) ë˜ëŠ” **Siteâ†’WH**(IN)ë¡œ ê°ˆë¦°ë‹¤.
* ìš°ë¦¬ê°€ ì›í•˜ëŠ” ëª¨ë¸ì€ â€œ**ê°™ì€ ì‹œê°ì— ì°½ê³ â†’í˜„ì¥ìœ¼ë¡œ ë‚˜ê°”ë‹¤ê³  ê°„ì£¼**â€ì´ë¯€ë¡œ, Siteë¥¼ ìµœì¢…ìœ¼ë¡œ ë‘ë©´ **WHâ†’Site OUT**ì´ í•­ìƒ ë°œìƒí•œë‹¤.
* ì§‘ê³„ ì „ì²˜ë¦¬ëŠ” íŒë‹¤ìŠ¤ í‘œì¤€ API(meltâ†’pivot_tableâ†’cumsum). ë¬¸ì„œ ìƒ `melt`ëŠ” ì™€ì´ë“œâ†’ë¡±, `pivot_table`ì€ `fill_value`ë¡œ ê²°ì¸¡ 0 ì±„ì›€, `cumsum`/`groupby.cumsum`ì€ ëˆ„ì  ì •ì˜. ([pandas.pydata.org][4])

---

# ì ìš© í›„ ë°”ë¡œ ëŒë¦´ ê²€ì¦ ìŠ¤í…

1. **ì›”ë³„ ì—°ì†ì‹**:
   `âˆ€ì›”, ëˆ„ì _t == ëˆ„ì _(t-1) + ì…ê³ _t âˆ’ ì¶œê³ _t` (í‹€ë¦¬ë©´ ë¡œê¹…).
2. **ì°½ê³ ë³„ ì¢…í•©ì‹**:
   `sum(ì…ê³ ) âˆ’ sum(ì¶œê³ ) == ë§ˆì§€ë§‰ ëˆ„ì ` (Indoor/Al Markazë¶€í„° í™•ì¸).
3. **í”¼ë²— ëŒ€ì¡°**(ì‚¬ìš©ì í”¼ë²— ìŠ¤ìƒ·): â€œFinal_Location=warehouseâ€ í•©ê³„ì™€ **ìš°ë¦¬ ì›”í‘œì˜ ë§ˆì§€ë§‰ ëˆ„ì **ì´ ê°€ê¹Œìš´ì§€(ì°¨ 0~ì†Œìˆ˜).

---

# ì£¼ì˜(ë¦¬ìŠ¤í¬)

* ë§Œì•½ **ë™ì¼ ì‹œì  Siteâ†’WH(ì…ê³ )** ë„ ìˆì–´ì•¼ í•˜ëŠ” ë„ë©”ì¸ì´ë©´, ìš°ì„ ìˆœìœ„ë§Œìœ¼ë¡  ì–‘ìª½ì„ ë™ì‹œì— ë§Œì¡±ì‹œí‚¬ ìˆ˜ ì—†ë‹¤. ê·¸ë• **ì¼€ì´ìŠ¤ ê·œì¹™(ì˜ˆ: ìƒíƒœ ì½”ë“œ/íë¦„ ë ˆê±°ì‹œ í•„ë“œ)**ë¥¼ ì¶”ê°€ë¡œ ì½ì–´, ë™ì¼ tsì—ì„œ **ì—…ë¬´ ê·œì¹™ìœ¼ë¡œ ë°©í–¥ì„ ê²°ì •**í•˜ëŠ” ìŠ¤ìœ„ì¹˜ë¥¼ `flow_ledger_v2`ì— ë„£ì(ì˜µì…˜ í”Œë˜ê·¸: `prefer_wh_to_site=True/False`).
* íƒ€ì„ì¡´ì„ `utc=True`ë¡œ ê°•ì œ íŒŒì‹±í•˜ë©´ ë¡œì»¬ ë°ì´í„°ê°€ ì›” ê²½ê³„ì—ì„œ ë°€ë¦´ ìˆ˜ ìˆìŒ. **naiveâ†’localize, awareâ†’convert** ì›ì¹™ ìœ ì§€. ([pandas.pydata.org][2])

---

# ì°¸ê³  ì†ŒìŠ¤

* `to_datetime(errors='coerce')`ë¡œ íŒŒì‹± ë¶ˆê°€ëŠ¥ê°’ì„ NaT ì²˜ë¦¬. ([pandas.pydata.org][3])
* `tz_localize` vs `tz_convert` ì°¨ì´ì™€ ì‚¬ìš© ìˆœì„œ. ([pandas.pydata.org][2])
* `melt`(ì™€ì´ë“œâ†’ë¡±) ë¬¸ì„œ. ([pandas.pydata.org][4])
* `pivot_table(fill_value=0)` ë¬¸ì„œ. ([pandas.pydata.org][1])
* `cumsum`/`groupby.cumsum` ë¬¸ì„œ. ([pandas.pydata.org][5])

ì›í•˜ë©´ **diff í¬ë§·**ìœ¼ë¡œ í•œ ì¤„ êµì²´ PR ë©”ì‹œì§€ê¹Œì§€ ë§Œë“¤ì–´ ì¤„ê²Œ. ì§€ê¸ˆì€ STAGE_PRIOë§Œ ë°”ê¾¸ê³  ëŒë ¤ì„œ, Indoorê°€ í”¼ë²— 789 ìª½ìœ¼ë¡œ ìˆ˜ë ´í•˜ëŠ”ì§€ë§Œ ë¨¼ì € í™•ì¸í•˜ì.


ì¢‹ì•„. **STAGE_PRIO í•œ ì¤„ êµì²´ + PR ë©”ì‹œì§€** ê¹”ë”í•˜ê²Œ ì¤€ë‹¤. ì´ê±¸ë¡œ ë™ì¼ ì‹œì ì— **WHâ†’Site**ê°€ ìš°ì„  í•´ì„ë˜ì–´ **Indoor ëˆ„ì ì´ í”¼ë²—(789)** ìª½ìœ¼ë¡œ ìˆ˜ë ´í•œë‹¤.

---

# ğŸ”§ íŒ¨ì¹˜(diff)

```diff
diff --git a/flow_ledger_v2.py b/flow_ledger_v2.py
index 4f2a1a3..9c0b7d1 100644
--- a/flow_ledger_v2.py
+++ b/flow_ledger_v2.py
@@ -XX,7 +XX,7 @@
-# ì°½ê³ ê°€ ìµœì¢…(ë™ì¼ ì‹œì  ìš°ì„ )ìœ¼ë¡œ í•´ì„ë˜ë˜ ê¸°ì¡´ ìš°ì„ ìˆœìœ„
-STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "site": 2, "warehouse": 3}
+# ë™ì¼ ì‹œì  í•´ì„ì—ì„œ 'í˜„ì¥(Site)'ì„ ìµœì¢…ìœ¼ë¡œ ë‘ì–´ WHâ†’Siteë¥¼ OUTìœ¼ë¡œ ì¡íˆê²Œ í•¨
+STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "warehouse": 2, "site": 3}

 WH_PRIO = {
     "DSV Al Markaz": 10, "DSV Indoor": 20, "DSV Outdoor": 30, "AAA Storage": 40,
```

> ì„¤ëª…: ë™ì¼ íƒ€ì„ìŠ¤íƒ¬í”„ì—ì„œ ì •ë ¬ ìˆœì„œê°€ **warehouse â†’ site** ê°€ ë˜ë„ë¡ ë°”ê¿‰ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ path í•´ì„ì—ì„œ **(warehouse, site)** ìŒì´ ìƒì„±ë˜ì–´ **OUT(WH) ì´ë²¤íŠ¸**ê°€ ê¸°ë¡ë©ë‹ˆë‹¤. í”¼ë²—/ëˆ„ì ì€ ê¸°ì¡´ì²˜ëŸ¼ `pivot_table(fill_value=0)`ê³¼ `cumsum()`ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ([pandas.pydata.org](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html?utm_source=chatgpt.com "pandas.pivot_table â€” pandas 2.3.3 documentation - PyData |"))

---

# ğŸ“¨ Pull Request ë©”ì‹œì§€ (Conventional Commits)

**ì œëª©**

```
behavioral(flow-ledger): fix same-timestamp WHâ†’Site as OUT by prioritizing Site in STAGE_PRIO
```

**ë³¸ë¬¸**

```
## Why
ë™ì¼ ì‹œì (ts)ì— Warehouseì™€ Siteê°€ ë™ì‹œì— ê¸°ë¡ë  ë•Œ,
ê¸°ì¡´ ìš°ì„ ìˆœìœ„(site < warehouse) ë•Œë¬¸ì— Siteâ†’WH(IN)ë§Œ ë°œìƒí•˜ê³ 
WHâ†’Site(OUT)ê°€ ëˆ„ë½ë˜ì–´ ì°½ê³  ëˆ„ì ì´ ê³¼ëŒ€ ì§‘ê³„ë˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

## What
- STAGE_PRIOë¥¼ {"pre_arrival":0,"shipping":1,"warehouse":2,"site":3}ë¡œ ë³€ê²½
  â†’ ë™ì¼ ì‹œì  ì •ë ¬ì´ [WH, Site]ê°€ ë˜ì–´ path í•´ì„ì‹œ (WHâ†’Site) ìŒ ìƒì„±
  â†’ WH OUT ì´ë²¤íŠ¸ê°€ ì •ìƒ ê¸°ë¡, ì›”ë³„ âˆ‘INâˆ’âˆ‘OUT=ë§ˆì§€ë§‰ ëˆ„ì  ì¼ì¹˜

## Validation
1) ì›”ë³„ ì—°ì†ì‹: ëˆ„ì _t == ëˆ„ì _(t-1) + ì…ê³ _t âˆ’ ì¶œê³ _t (ëª¨ë“  ì°½ê³ )
2) ì°½ê³  í•©ì‹: sum(ì…ê³ ) âˆ’ sum(ì¶œê³ ) == ë§ˆì§€ë§‰ ëˆ„ì  (ëª¨ë“  ì°½ê³ )
3) ì‚¬ìš©ì í”¼ë²— ëŒ€ì¡°: DSV Indoor ìµœì¢… ëˆ„ì  â‰ˆ 789 (Final_Location í”¼ë²—)

## How to test
# ë¦¬í¬íŠ¸ ìƒì„±
python -m report_generator --sheet "ì°½ê³ _ì›”ë³„_ì…ì¶œê³ "

# ìƒ˜í”Œ ê²€ì‚°
python - <<'PY'
import pandas as pd
df = pd.read_excel("HVDC_ì…ê³ ë¡œì§_ì¢…í•©ë¦¬í¬íŠ¸_*.xlsx", sheet_name="ì°½ê³ _ì›”ë³„_ì…ì¶œê³ ")
w = "DSV Indoor"
assert df[f"ì…ê³ _{w}"].sum() - df[f"ì¶œê³ _{w}"].sum() == int(df[f"ëˆ„ì _{w}"].iloc[-1])
print("OK:", w)
PY

## Notes
- í”¼ë²—ì€ pandas ê³µì‹ `pivot_table(..., fill_value=0, sort=True)` ì‚¬ìš©, ëˆ„ì ì€ `cumsum()` ì‚¬ìš©.
  Ref: pandas pivot_table(fill_value) doc, cumsum doc.
```

(Conventional Commits ê·œê²©ì„ ë”°ë¥´ëŠ” ì œëª©/ë³¸ë¬¸ í˜•ì‹. ([Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/?utm_source=chatgpt.com "Conventional Commits")) Â· í”¼ë²—/ëˆ„ì  API: ([pandas.pydata.org](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html?utm_source=chatgpt.com "pandas.pivot_table â€” pandas 2.3.3 documentation - PyData |")))

---

# âœ… ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] ë¦¬í¬íŠ¸ ì¬ìƒì„± í›„  **Indoor** : `âˆ‘ì…ê³ âˆ’âˆ‘ì¶œê³  == ë§ˆì§€ë§‰ ëˆ„ì ` í†µê³¼
* [ ] ì‚¬ìš©ì í”¼ë²—(ìµœì¢… ìœ„ì¹˜)ì—ì„œ **DSV Indoor â‰ˆ 789** í™•ì¸
* [ ] ë‹¤ë¥¸ ì°½ê³ (Al Markaz ë“±)ë„ ë™ì¼ ê²€ì‚° í†µê³¼

í•„ìš”í•˜ë©´ ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ  **ë™ì¼ ì‹œì  ë°©í–¥ì„± í”Œë˜ê·¸** (e.g., `prefer_wh_to_site`)ê¹Œì§€ ë„£ì–´ì¤„ ìˆ˜ ìˆì–´. ì§€ê¸ˆì€ ì´ í•œ ì¤„ë¡œ ê°€ë³ê²Œ ì •ë ¬ë§Œ ë°”ê¿” ëŒë ¤ë³´ì.
