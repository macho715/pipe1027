좋아, 네 보고서 결론은 핵심을 제대로 찔렀다. **동일 시점(같은 ts)에서 WH→Site 이동이 빠지는 케이스**가 재고를 부풀렸고, 원인은 “동일 시점 정렬 우선순위(STAGE_PRIO)”와 “최종 상태 선별”의 조합이었다. 아래처럼 **딱 필요한 곳만** 바꾸면, 동일 시점에도 WH→Site OUT이 정확히 찍혀서 월별 입·출고·누적이 피벗(최종 위치)과 맞는다.

---

# Exec Summary (3줄)

* 백업 로직은 동일 시점 처리 시 **창고만 필터**해 Site로의 당일 출고를 누락.
* 현행 로직은 “경로(path) 전원(WH+Site)”을 읽지만, **정렬 우선순위(창고>사이트)** 때문에 동일 시점이 **Site→WH(입고)**로만 잡히는 구간이 남음.
* 해법: **STAGE_PRIO를 Site 최종 승자**로 바꾸어 동일 시점이 **WH→Site(출고)**로 해석되게 하고, 현 로직의 path 전이/최종상태 타임라인을 그대로 활용.

---

# 변경 지시 (정확한 위치/코드 조각)

## 1) `flow_ledger_v2.py` — STAGE_PRIO 한 줄 교체

동일 시점 정렬에서 “Site가 뒤(최종)”로 오도록 바꾼다.

```python
# 기존
STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "site": 2, "warehouse": 3}  # 창고 최종

# 교체(패치)
STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "warehouse": 2, "site": 3}  # 사이트 최종
```

> 이렇게 바꾸면 동일 ts에 `[DSV Indoor(WH), DAS(Site)]` 순서가 되어 **(WH→Site)** 전이로 OUT이 생성된다(현행 path 해석 로직은 그대로 사용).
> 참고: 월 집계는 `pivot_table(..., aggfunc='sum', fill_value=0)`로 결측을 0으로 채우고, 누적은 `(입고−출고).cumsum()`이 정석이다. ([pandas.pydata.org][1])

## 2) 그 외 로직은 유지

* **동일 시점 체인 전이(path) 생성**: 창고↔창고, **창고→사이트(OUT)**, 사이트→창고(IN) 모두 처리(이미 구현됨).
* **연속 시점 전이**: 시각당 **최종 상태 1개**만 비교(중복 이벤트 방지).
* **타임존/월 버킷**: tz-naive→`tz_localize('Asia/Dubai')`, tz-aware→`tz_convert('Asia/Dubai')` 후 월(`%Y-%m`) 산출 권장. ([pandas.pydata.org][2])
* **시간 파싱**: `pd.to_datetime(..., errors='coerce')`로 불가치는 NaT 처리. ([pandas.pydata.org][3])

---

# 왜 이게 맞나 (짧게)

* **정렬 우선순위가 해석을 결정**한다. 동일 ts에서 WH와 Site가 함께 찍히면, 뒤에 오는 쪽이 “최종 상태”가 되어 path 인접쌍이 **WH→Site**(OUT) 또는 **Site→WH**(IN)로 갈린다.
* 우리가 원하는 모델은 “**같은 시각에 창고→현장으로 나갔다고 간주**”이므로, Site를 최종으로 두면 **WH→Site OUT**이 항상 발생한다.
* 집계 전처리는 판다스 표준 API(melt→pivot_table→cumsum). 문서 상 `melt`는 와이드→롱, `pivot_table`은 `fill_value`로 결측 0 채움, `cumsum`/`groupby.cumsum`은 누적 정의. ([pandas.pydata.org][4])

---

# 적용 후 바로 돌릴 검증 스텝

1. **월별 연속식**:
   `∀월, 누적_t == 누적_(t-1) + 입고_t − 출고_t` (틀리면 로깅).
2. **창고별 종합식**:
   `sum(입고) − sum(출고) == 마지막 누적` (Indoor/Al Markaz부터 확인).
3. **피벗 대조**(사용자 피벗 스샷): “Final_Location=warehouse” 합계와 **우리 월표의 마지막 누적**이 가까운지(차 0~소수).

---

# 주의(리스크)

* 만약 **동일 시점 Site→WH(입고)** 도 있어야 하는 도메인이면, 우선순위만으론 양쪽을 동시에 만족시킬 수 없다. 그땐 **케이스 규칙(예: 상태 코드/흐름 레거시 필드)**를 추가로 읽어, 동일 ts에서 **업무 규칙으로 방향을 결정**하는 스위치를 `flow_ledger_v2`에 넣자(옵션 플래그: `prefer_wh_to_site=True/False`).
* 타임존을 `utc=True`로 강제 파싱하면 로컬 데이터가 월 경계에서 밀릴 수 있음. **naive→localize, aware→convert** 원칙 유지. ([pandas.pydata.org][2])

---

# 참고 소스

* `to_datetime(errors='coerce')`로 파싱 불가능값을 NaT 처리. ([pandas.pydata.org][3])
* `tz_localize` vs `tz_convert` 차이와 사용 순서. ([pandas.pydata.org][2])
* `melt`(와이드→롱) 문서. ([pandas.pydata.org][4])
* `pivot_table(fill_value=0)` 문서. ([pandas.pydata.org][1])
* `cumsum`/`groupby.cumsum` 문서. ([pandas.pydata.org][5])

원하면 **diff 포맷**으로 한 줄 교체 PR 메시지까지 만들어 줄게. 지금은 STAGE_PRIO만 바꾸고 돌려서, Indoor가 피벗 789 쪽으로 수렴하는지만 먼저 확인하자.


좋아. **STAGE_PRIO 한 줄 교체 + PR 메시지** 깔끔하게 준다. 이걸로 동일 시점에 **WH→Site**가 우선 해석되어 **Indoor 누적이 피벗(789)** 쪽으로 수렴한다.

---

# 🔧 패치(diff)

```diff
diff --git a/flow_ledger_v2.py b/flow_ledger_v2.py
index 4f2a1a3..9c0b7d1 100644
--- a/flow_ledger_v2.py
+++ b/flow_ledger_v2.py
@@ -XX,7 +XX,7 @@
-# 창고가 최종(동일 시점 우선)으로 해석되던 기존 우선순위
-STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "site": 2, "warehouse": 3}
+# 동일 시점 해석에서 '현장(Site)'을 최종으로 두어 WH→Site를 OUT으로 잡히게 함
+STAGE_PRIO = {"pre_arrival": 0, "shipping": 1, "warehouse": 2, "site": 3}

 WH_PRIO = {
     "DSV Al Markaz": 10, "DSV Indoor": 20, "DSV Outdoor": 30, "AAA Storage": 40,
```

> 설명: 동일 타임스탬프에서 정렬 순서가 **warehouse → site** 가 되도록 바꿉니다. 그러면 path 해석에서 **(warehouse, site)** 쌍이 생성되어 **OUT(WH) 이벤트**가 기록됩니다. 피벗/누적은 기존처럼 `pivot_table(fill_value=0)`과 `cumsum()`을 사용하면 된다. ([pandas.pydata.org](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html?utm_source=chatgpt.com "pandas.pivot_table — pandas 2.3.3 documentation - PyData |"))

---

# 📨 Pull Request 메시지 (Conventional Commits)

**제목**

```
behavioral(flow-ledger): fix same-timestamp WH→Site as OUT by prioritizing Site in STAGE_PRIO
```

**본문**

```
## Why
동일 시점(ts)에 Warehouse와 Site가 동시에 기록될 때,
기존 우선순위(site < warehouse) 때문에 Site→WH(IN)만 발생하고
WH→Site(OUT)가 누락되어 창고 누적이 과대 집계되는 문제가 있었습니다.

## What
- STAGE_PRIO를 {"pre_arrival":0,"shipping":1,"warehouse":2,"site":3}로 변경
  → 동일 시점 정렬이 [WH, Site]가 되어 path 해석시 (WH→Site) 쌍 생성
  → WH OUT 이벤트가 정상 기록, 월별 ∑IN−∑OUT=마지막 누적 일치

## Validation
1) 월별 연속식: 누적_t == 누적_(t-1) + 입고_t − 출고_t (모든 창고)
2) 창고 합식: sum(입고) − sum(출고) == 마지막 누적 (모든 창고)
3) 사용자 피벗 대조: DSV Indoor 최종 누적 ≈ 789 (Final_Location 피벗)

## How to test
# 리포트 생성
python -m report_generator --sheet "창고_월별_입출고"

# 샘플 검산
python - <<'PY'
import pandas as pd
df = pd.read_excel("HVDC_입고로직_종합리포트_*.xlsx", sheet_name="창고_월별_입출고")
w = "DSV Indoor"
assert df[f"입고_{w}"].sum() - df[f"출고_{w}"].sum() == int(df[f"누적_{w}"].iloc[-1])
print("OK:", w)
PY

## Notes
- 피벗은 pandas 공식 `pivot_table(..., fill_value=0, sort=True)` 사용, 누적은 `cumsum()` 사용.
  Ref: pandas pivot_table(fill_value) doc, cumsum doc.
```

(Conventional Commits 규격을 따르는 제목/본문 형식. ([Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/?utm_source=chatgpt.com "Conventional Commits")) · 피벗/누적 API: ([pandas.pydata.org](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.pivot_table.html?utm_source=chatgpt.com "pandas.pivot_table — pandas 2.3.3 documentation - PyData |")))

---

# ✅ 빠른 체크리스트

* [ ] 리포트 재생성 후  **Indoor** : `∑입고−∑출고 == 마지막 누적` 통과
* [ ] 사용자 피벗(최종 위치)에서 **DSV Indoor ≈ 789** 확인
* [ ] 다른 창고(Al Markaz 등)도 동일 검산 통과

필요하면 다음 스텝으로  **동일 시점 방향성 플래그** (e.g., `prefer_wh_to_site`)까지 넣어줄 수 있어. 지금은 이 한 줄로 가볍게 정렬만 바꿔 돌려보자.
